---
title: "Invert Sampling Cleaning"
author: "Chris Kracha"
date: "2023-01-28"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(janitor)
library(vegan)
library("hydroTSM")
```

# load in tables
```{r message=FALSE}
inv2018csv <- read_csv("downloaded tables/2018_raw_normalized.csv", skip = 5)
inv2019csv <- read_csv("downloaded tables/2019_normalized.csv", skip = 1)
inv2021_22csv <- read_csv("downloaded tables/2021_raw.csv")
```

# reformat year tables to match
```{r}

inv2018 <- inv2018csv %>% clean_names() %>% select(1:42, -4) %>% # remove blank
  # keep only the rows with dates
  filter(!is.na(date_1)) %>%
  select(1:3, ends_with("_number_liter")) %>%
  rename_with(~ gsub("_number_liter", "", .x))

inv2019 <- inv2019csv %>% clean_names() %>% select(1:42, -4) %>% 
  # keep only the rows with dates
  filter(!is.na(date_1), !is.na(site_2))%>%
  mutate(across(ostracod:total_number, ~as.numeric(.)),
         date_1 = dmy(date_1)) %>%
  rename(date = date_1,
         site = site_2,
         sample_type = sample_type_3)

inv2021 <- inv2021_22csv %>% clean_names() %>%
  # remove unused variables
  select(-person_entering_data, 
         -person_that_sorted_the_sample) %>%
  # replace species NAs with zeroes
  mutate(across(ostracod:isopod, ~replace_na(.,0)),
         # convert to organisms/L
         across(ostracod:isopod, ~.x/7.5),
         # make numeric
         across(ostracod:isopod, ~as.numeric(.)),
         # format date
         date_on_vial = dmy(date_on_vial)) %>%
  rename(date = date_on_vial,
         diptera_ceratopogonidae = diptera_ceratopohonidae)

```


# combine 2019 and 2021-22
```{r}
inv2021_2019 <- inv2021 %>% select(-lepidoptera_crambidae,
                              -hemiptera_mesoveliidae,
                              -ephemeroptera,
                              -coleoptera_tropiscernus,
                              -plecoptera_sp,
                              -mollusk, -syrphidae,
                              -terrestrials,
                              -hydrachnidia, -isopod, -larvae,
                              -comments, -x57, -unknown, -total_number) %>%
  bind_rows(., inv2019)

inv2021_2019_totals <- inv2021_2019 %>% select(1:3, ostracod, copepod, nematode, diptera_total, amphipod, hemiptera_total, annelida_total, ephemeroptera_sp, trichoptera_sp, odonate, coleoptera_total, tipulidae_larva, arachnida_acari_mite, collembola_springtail, gastropod_snail) %>%
  mutate(total_organisms = rowSums(.[4:18], na.rm=TRUE),
         month = month(date),
         season = time2season(date, out.fmt = "seasons"))

testInv <- inv2021_2019_totals %>% pivot_longer(cols = ostracod:gastropod_snail, 
                                      names_to = "species", 
                                      values_to = "count") %>%
  ggplot(aes(x = count, y = species, fill = species)) + geom_bar(stat = "identity") +
  facet_wrap(~site)

inv2021_2019_totals %>% filter(sample_type == "FB250") %>%
  ggplot(aes(x = month, y = total_organisms)) + geom_bar(stat = "identity")

inv2021_2019_totals %>% filter(sample_type == "FB250") %>%
  ggplot(aes(x = season, y = total_organisms)) + geom_bar(stat = "identity")
```

