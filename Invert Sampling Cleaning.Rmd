---
title: "Invert Sampling Cleaning"
author: "Chris Kracha"
date: "2023-01-28"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(janitor)
library(vegan)
library("hydroTSM")
```

# load in tables
```{r message=FALSE}
inv2018csv <- read_csv("downloaded tables/2018_raw_normalized.csv", skip = 5)
inv2019csv <- read_csv("downloaded tables/2019_normalized.csv", skip = 1)
inv2021_22csv <- read_csv("downloaded tables/2021_raw.csv")
```

# format tables for each year
```{r}
inv2018 <- inv2018csv %>% clean_names() %>% 
  # get relevant columns
  select(1:42, -4) %>%
  # keep only the rows with dates
  filter(!is.na(date_1)) %>%
  # select normalized columns
  select(1:3, ends_with("_number_liter")) %>%
  # remove _number_liter from names
  rename_with(~ gsub("_number_liter", "", .x)) %>%
  # replace species NAs with zeroes
  mutate(across(ostracod:amphipod, ~replace_na(.,0)),
          # format date
         date_1 = dmy(date_1))

inv2019 <- inv2019csv %>% clean_names() %>% 
  select(1:42, -4, -total_number) %>% 
  # keep only the rows with dates
  filter(!is.na(date_1), !is.na(site_2)) %>%
  # make species numeric
  mutate(across(ostracod:clam_shrimp, ~as.numeric(.)),
         # replace species NAs with zeroes
         across(ostracod:clam_shrimp, ~replace_na(.,0)),
         # format date
         date_1 = dmy(date_1))

inv2021 <- inv2021_22csv %>% clean_names() %>%
  # remove unused variables
  select(-person_entering_data, -person_that_sorted_the_sample, 
         -total_number, -unknown, -x57, -comments) %>% 
  # remove unfinished samples
  filter(!row_number() %in% c(7, 24, 26)) %>%
  # replace species NAs with zeroes
  mutate(across(ostracod:larvae, ~replace_na(.,0)),
         # normalize species counts by liter
         across(ostracod:larvae, ~.x/7.5),
         # make species numeric
         across(ostracod:larvae, ~as.numeric(.)),
         # format date
         date_on_vial = dmy(date_on_vial))

```

# rename columns to match
```{r}
inv2018 <- inv2018  %>% 
  rename(date = date_1,
         site = site_2,
         sample_type = sample_type_3,
         # add order to names
         hemiptera_corixidae_boatman = corixidae_boatman,
         diptera_chironomid = chironomid,
         diptera_ceratopogonidae = ceratopogonidae,
         diptera_ephydridae = ephydridae,
         diptera_stratiomyidae = stratiomyidae,
         diptera_culicidae = culicidae,
         arachnida_acari = mile, # misspell
         hemiptera_notonectidae = heteroptera_backswimmer,
         coleoptera_sp = aquatic_coleoptera_sp,
         coleoptera_hydrophilidae = coleoptera_hydrophilidae_biter,
         coleoptera_hydraenidae = coleoptera_hydraenidae_stripes,
         coleoptera_dytiscidae = coleoptera_dystiscidae) # fix spelling

inv2019 <- inv2019 %>% 
  rename(date = date_1,
         site = site_2,
         sample_type = sample_type_3,
         ephemeroptera = ephemeroptera_sp,
         arachnida_acari = arachnida_acari_mite,
         coleoptera_hydraenidae = coleoperta_hydraenidae)

inv2021 <- inv2021 %>% 
  rename(date = date_on_vial,
         diptera_syrphidae = syrphidae,
         plecoptera = plecoptera_sp,
         diptera_ceratopogonidae = diptera_ceratopohonidae)
```

# combine all columns
```{r}
inv <- bind_rows(inv2018, inv2019, inv2021)
colnames(inv)
```

# combine 2019 and 2021-22
```{r}
inv2021_2019 <- inv2021 %>% 
  # remove columns that aren;t in 2019
  select(-lepidoptera_crambidae, -hemiptera_mesoveliidae, -ephemeroptera,
         -coleoptera_tropiscernus, -plecoptera_sp, -mollusk, -syrphidae,
         -terrestrials, -hydrachnidia, -isopod, -larvae, -comments, -x57, 
         -unknown, -total_number) %>%
  bind_rows(., inv2019)

inv2021_2019_totals <- inv2021_2019 %>% select(1:3, ostracod, copepod, nematode, diptera_total, amphipod, hemiptera_total, annelida_total, ephemeroptera_sp, trichoptera_sp, odonate, coleoptera_total, tipulidae_larva, arachnida_acari_mite, collembola_springtail, gastropod_snail) %>%
  mutate(total_organisms = rowSums(.[4:18], na.rm=TRUE),
         month = month(date),
         season = time2season(date, out.fmt = "seasons"))

testInv <- inv2021_2019_totals %>% pivot_longer(cols = ostracod:gastropod_snail, 
                                      names_to = "species", 
                                      values_to = "count") %>%
  ggplot(aes(x = count, y = species, fill = species)) + geom_bar(stat = "identity") +
  facet_wrap(~site)

inv2021_2019_totals %>% filter(sample_type == "FB250") %>%
  ggplot(aes(x = month, y = total_organisms)) + geom_bar(stat = "identity")

inv2021_2019_totals %>% filter(sample_type == "FB250") %>%
  ggplot(aes(x = season, y = total_organisms)) + geom_bar(stat = "identity")
```

